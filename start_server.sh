#!/bin/bash

echo "üöÄ –ó–∞–ø—É—Å–∫ BookAI –ø—Ä–æ–µ–∫—Ç–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ..."
echo "=================================================="

# –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ
source venv/bin/activate

# –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∞—Ä—ã–µ –ø—Ä–æ—Ü–µ—Å—Å—ã
echo "üõë –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å—Ç–∞—Ä—ã—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤..."
pkill -f 'uvicorn|bot.py|npm|node' 2>/dev/null
sleep 2

# –ó–∞–ø—É—Å–∫ –±—ç–∫–µ–Ω–¥–∞ –≤ —Ñ–æ–Ω–µ
echo "üì° –ó–∞–ø—É—Å–∫ –±—ç–∫–µ–Ω–¥–∞..."
nohup python -m uvicorn admin_backend.main:app --host 0.0.0.0 --port 8000 > backend.log 2>&1 &
BACKEND_PID=$!
echo "‚úÖ –ë—ç–∫–µ–Ω–¥ –∑–∞–ø—É—â–µ–Ω (PID: $BACKEND_PID)"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ø—Ä–æ—Ü–µ—Å—Å –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –∑–∞–ø—É—Å—Ç–∏–ª—Å—è
sleep 1
if ! kill -0 $BACKEND_PID 2>/dev/null; then
    echo "‚ùå –ü—Ä–æ—Ü–µ—Å—Å –±—ç–∫–µ–Ω–¥–∞ –∑–∞–≤–µ—Ä—à–∏–ª—Å—è —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ –∑–∞–ø—É—Å–∫–∞"
    echo "üìã –õ–æ–≥ –±—ç–∫–µ–Ω–¥–∞:"
    cat backend.log
    exit 1
fi

# –ñ–¥–µ–º –∑–∞–ø—É—Å–∫–∞ –±—ç–∫–µ–Ω–¥–∞ —Å –ø–æ–≤—Ç–æ—Ä–Ω—ã–º–∏ –ø—Ä–æ–≤–µ—Ä–∫–∞–º–∏
echo "‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–ø—É—Å–∫–∞ –±—ç–∫–µ–Ω–¥–∞..."
for i in {1..30}; do
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –ø–æ—Ä—Ç–∞
    if netstat -tuln 2>/dev/null | grep -q ":8000.*LISTEN" || ss -tuln 2>/dev/null | grep -q ":8000.*LISTEN"; then
        # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ –ø—Ä–æ–≤–µ—Ä—è–µ–º HTTP –æ—Ç–≤–µ—Ç
        if curl -s http://localhost:8000/docs > /dev/null 2>&1; then
            echo "‚úÖ –ë—ç–∫–µ–Ω–¥ –¥–æ—Å—Ç—É–ø–µ–Ω (–ø–æ–ø—ã—Ç–∫–∞ $i/30)"
            break
        fi
    fi
    
    if [ $i -eq 30 ]; then
        echo "‚ùå –ë—ç–∫–µ–Ω–¥ –Ω–µ –∑–∞–ø—É—Å—Ç–∏–ª—Å—è –∑–∞ 30 –ø–æ–ø—ã—Ç–æ–∫"
        echo "üìã –°—Ç–∞—Ç—É—Å –ø—Ä–æ—Ü–µ—Å—Å–∞:"
        if kill -0 $BACKEND_PID 2>/dev/null; then
            echo "  –ü—Ä–æ—Ü–µ—Å—Å $BACKEND_PID —Ä–∞–±–æ—Ç–∞–µ—Ç"
        else
            echo "  –ü—Ä–æ—Ü–µ—Å—Å $BACKEND_PID –∑–∞–≤–µ—Ä—à–∏–ª—Å—è"
        fi
        echo "üìã –ü–æ—Å–ª–µ–¥–Ω–∏–µ —Å—Ç—Ä–æ–∫–∏ –ª–æ–≥–∞ –±—ç–∫–µ–Ω–¥–∞:"
        tail -20 backend.log
        echo "üìã –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Ä—Ç–æ–≤:"
        netstat -tuln 2>/dev/null | grep 8000 || echo "  –ü–æ—Ä—Ç 8000 –Ω–µ —Å–ª—É—à–∞–µ—Ç—Å—è"
        exit 1
    fi
    echo "‚è≥ –ü–æ–ø—ã—Ç–∫–∞ $i/30 - –æ–∂–∏–¥–∞–Ω–∏–µ –∑–∞–ø—É—Å–∫–∞ –±—ç–∫–µ–Ω–¥–∞..."
    sleep 2
done

# –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞ –≤ —Ñ–æ–Ω–µ
echo "ü§ñ –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞..."
nohup python bot.py > bot.log 2>&1 &
BOT_PID=$!
echo "‚úÖ –ë–æ—Ç –∑–∞–ø—É—â–µ–Ω (PID: $BOT_PID)"

# –ó–∞–ø—É—Å–∫ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞ –≤ —Ñ–æ–Ω–µ
echo "üåê –ó–∞–ø—É—Å–∫ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞..."
cd admin_frontend
nohup npm start > frontend.log 2>&1 &
FRONTEND_PID=$!
echo "‚úÖ –§—Ä–æ–Ω—Ç–µ–Ω–¥ –∑–∞–ø—É—â–µ–Ω (PID: $FRONTEND_PID)"

# –í–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –≤ –∫–æ—Ä–Ω–µ–≤—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
cd ..

echo ""
echo "üéâ –í—Å–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –∑–∞–ø—É—â–µ–Ω—ã!"
echo "üì± –ë–æ—Ç: Telegram –±–æ—Ç"
echo "ÔøΩÔøΩ API: http://45.144.222.230:8000"
echo "ÔøΩÔøΩ –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è: http://45.144.222.230:8000/docs"
echo "ÔøΩÔøΩ –§—Ä–æ–Ω—Ç–µ–Ω–¥: http://45.144.222.230:3000"
echo "=================================================="
echo ""
echo "üí° –î–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –ª–æ–≥–æ–≤:"
echo "  tail -f backend.log"
echo "  tail -f bot.log"
echo "  tail -f frontend.log"
echo ""
echo "ÔøΩÔøΩ –î–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –≤—Å–µ—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤:"
echo "  ./stop_server.sh"
echo ""
echo "üìä –°—Ç–∞—Ç—É—Å –ø—Ä–æ—Ü–µ—Å—Å–æ–≤:"
ps aux | grep -E "(uvicorn|bot.py|npm)" | grep -v grep
